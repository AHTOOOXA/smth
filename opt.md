## До
 
```sql
WITH pro AS (SELECT product_id,  
                    seller_id,  
                    brand_id  
             FROM wb3.products p  
             WHERE product_id IN [45455651, 209551150, 171479487, 162088668, 87296764, 140176840, 172062042, 180508417, 174536964, 197499465, 169798083, 139731124, 7435911, 158867109, 6974230, 178447900, 189492098, 18172017, 26375661, 181093158, 115696961, 179411224, 39002896, 116494464, 114199802, 183884210, 95958761, 78506607, 151830264, 210222255, 174476975, 150260520, 97235874, 180265933, 23483721, 10950669, 8499992, 73047677, 66337908, 172062086, 36095415, 172062083, 200696646, 172941775, 154461994, 115538027, 139731125, 172062052, 175438962, 146882949, 13983434, 172062023, 197500817, 12650243, 172941776, 154689548, 6717493, 143764481, 205680906, 220183446, 19176827, 175742409, 172474750, 154555909, 177911707, 85118340, 146496646, 168305380, 19463571, 194557920, 146203007, 104646975, 190058629, 194557918, 211340130, 163680187, 172062022, 145296450, 173110018, 146643928, 87296761, 172061982, 185540768, 148908477, 173228181, 173228182, 154461992, 171792357, 203731977, 90442363, 222824370, 201856946, 170097601, 210228386, 217862988, 143010187, 170088191, 197892813, 154942684, 142613311]),  
     rem AS (SELECT DISTINCT ON (product_id) date       AS date,  
                                             product_id AS product_id,  
                                             revenue_fba_30  AS revenue_total  
             FROM wb3.remainders  
             WHERE (date, product_id) IN (SELECT history[1] AS history_date, product_id  
                                          FROM wb3.products_history  
                                          WHERE product_id IN [45455651, 209551150, 171479487, 162088668, 87296764, 140176840, 172062042, 180508417, 174536964, 197499465, 169798083, 139731124, 7435911, 158867109, 6974230, 178447900, 189492098, 18172017, 26375661, 181093158, 115696961, 179411224, 39002896, 116494464, 114199802, 183884210, 95958761, 78506607, 151830264, 210222255, 174476975, 150260520, 97235874, 180265933, 23483721, 10950669, 8499992, 73047677, 66337908, 172062086, 36095415, 172062083, 200696646, 172941775, 154461994, 115538027, 139731125, 172062052, 175438962, 146882949, 13983434, 172062023, 197500817, 12650243, 172941776, 154689548, 6717493, 143764481, 205680906, 220183446, 19176827, 175742409, 172474750, 154555909, 177911707, 85118340, 146496646, 168305380, 19463571, 194557920, 146203007, 104646975, 190058629, 194557918, 211340130, 163680187, 172062022, 145296450, 173110018, 146643928, 87296761, 172061982, 185540768, 148908477, 173228181, 173228182, 154461992, 171792357, 203731977, 90442363, 222824370, 201856946, 170097601, 210228386, 217862988, 143010187, 170088191, 197892813, 154942684, 142613311]  
                                            AND history_date >= today() - 30)  
             ORDER BY date DESC)  
SELECT pro.product_id    AS product_id,  
       rem.revenue_total AS revenue_total  
FROM pro  
         LEFT JOIN rem  
                   ON rem.product_id = pro.product_id  
    SETTINGS join_use_nulls = 1
```

```
100 rows in set. Elapsed: 0.403 sec. Processed 9.09 million rows, 255.06 MB (22.55 million rows/s., 632.67 MB/s.)
Peak memory usage: 153.90 MiB.
```

## После
Непонятно зачем нужно лезть в таблицу wb3.products

ORDER BY как будто бы не нужен? Непонятно что он вообще сортировал мы эту таблицу потом джойним направо

DISTINCT ON  ничего не делал??? Тут есть дубликаты тк мы wb3.products не фильтруем ![[CleanShot 2024-04-27 at 16.56.28@2x.png]]

Как будто бы так будет норм

```sql
WITH rem AS (SELECT DISTINCT ON (product_id) date           AS date,  
                                             product_id     AS product_id,  
                                             revenue_fba_30 AS revenue_total  
             FROM wb3.remainders  
             WHERE (date, product_id) IN (SELECT history[1] AS history_date, product_id  
                                          FROM wb3.products_history  
                                          WHERE product_id IN  
                                                [45455651, 209551150, 171479487, 162088668, 87296764, 140176840, 172062042, 180508417, 174536964, 197499465, 169798083, 139731124, 7435911, 158867109, 6974230, 178447900, 189492098, 18172017, 26375661, 181093158, 115696961, 179411224, 39002896, 116494464, 114199802, 183884210, 95958761, 78506607, 151830264, 210222255, 174476975, 150260520, 97235874, 180265933, 23483721, 10950669, 8499992, 73047677, 66337908, 172062086, 36095415, 172062083, 200696646, 172941775, 154461994, 115538027, 139731125, 172062052, 175438962, 146882949, 13983434, 172062023, 197500817, 12650243, 172941776, 154689548, 6717493, 143764481, 205680906, 220183446, 19176827, 175742409, 172474750, 154555909, 177911707, 85118340, 146496646, 168305380, 19463571, 194557920, 146203007, 104646975, 190058629, 194557918, 211340130, 163680187, 172062022, 145296450, 173110018, 146643928, 87296761, 172061982, 185540768, 148908477, 173228181, 173228182, 154461992, 171792357, 203731977, 90442363, 222824370, 201856946, 170097601, 210228386, 217862988, 143010187, 170088191, 197892813, 154942684, 142613311]  
                                            AND history_date >= today() - 30))  
SELECT rem.product_id    AS product_id,  
       rem.revenue_total AS revenue_total  
FROM rem  
    SETTINGS join_use_nulls = 1
```

```
100 rows in set. Elapsed: 0.185 sec. Processed 1.41 million rows, 217.63 MB (7.59 million rows/s., 1.17 GB/s.)
Peak memory usage: 153.57 MiB.
```

но я не оч понимаю 
1) что это за эндпоинт
2) что это за таблицы 
	   wb3.products (инфа по продукту с карточки?? updated поле только к этому относится?), 
	   wb3.remainders, 
	   wb3.product_history (значения в массиве history возможно полностью дублируют записи в wb3.remainders, не понимаю зачем она вообще нужна)

wb3.product_history это типо таблица оптимизация потому что запросы типо того что ниже сильно дольше работают?
```sql
WITH rem AS (SELECT product_id,  
                    argMax(revenue_fba_30, date) AS revenue_total  
             FROM wb3.remainders  
             WHERE date > today() - 30  
                AND product_id IN  
                   [45455651, 209551150, 171479487, 162088668, 87296764, 140176840, 172062042, 180508417, 174536964, 197499465, 169798083, 139731124, 7435911, 158867109, 6974230, 178447900, 189492098, 18172017, 26375661, 181093158, 115696961, 179411224, 39002896, 116494464, 114199802, 183884210, 95958761, 78506607, 151830264, 210222255, 174476975, 150260520, 97235874, 180265933, 23483721, 10950669, 8499992, 73047677, 66337908, 172062086, 36095415, 172062083, 200696646, 172941775, 154461994, 115538027, 139731125, 172062052, 175438962, 146882949, 13983434, 172062023, 197500817, 12650243, 172941776, 154689548, 6717493, 143764481, 205680906, 220183446, 19176827, 175742409, 172474750, 154555909, 177911707, 85118340, 146496646, 168305380, 19463571, 194557920, 146203007, 104646975, 190058629, 194557918, 211340130, 163680187, 172062022, 145296450, 173110018, 146643928, 87296761, 172061982, 185540768, 148908477, 173228181, 173228182, 154461992, 171792357, 203731977, 90442363, 222824370, 201856946, 170097601, 210228386, 217862988, 143010187, 170088191, 197892813, 154942684, 142613311]  
             GROUP BY product_id)  
SELECT rem.product_id    AS product_id,  
       rem.revenue_total AS revenue_total  
FROM rem  
    SETTINGS join_use_nulls = 1
```

```
100 rows in set. Elapsed: 0.832 sec. Processed 22.24 million rows, 172.91 MB (26.72 million rows/s., 207.71 MB/s.)
Peak memory usage: 7.73 MiB.
```

Но вроде как каноничное решение же сделать MV такой и из него уже селект будет оч быстрый
